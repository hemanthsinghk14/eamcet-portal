<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EAMCET Student Follow-Up System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }
        .auth-bg {
            background-color: #f3f4f6;
            background-image: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
        }
        .modal-backdrop {
            transition: opacity 0.3s ease-in-out;
            z-index: 50;
        }
        .modal-content {
            transform: translateY(-50px) scale(0.95);
            transition: transform 0.3s ease-out;
        }
        .modal-backdrop.show .modal-content {
            transform: translateY(0) scale(1);
        }
        #sidebar {
            transition: width 0.3s ease-in-out;
        }
        #main-content {
            transition: margin-left 0.3s ease-in-out;
        }
        .sidebar-link i {
            transition: transform 0.3s ease;
        }
        .sidebar-link:hover i {
            transform: scale(1.1);
        }
        .card {
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .fade-in-up {
            animation: fadeInUp 0.5s ease-out forwards;
        }
        
        #dashboard-view {
            display: flex;
            height: 100vh;
        }

        #sidebar.collapsed {
            width: 5rem; /* 80px */
        }
         #sidebar.collapsed .sidebar-text {
            display: none;
        }
        #sidebar.collapsed #desktop-collapse-btn i {
            transform: rotate(180deg);
        }
        #main-content {
            width: 100%;
        }
    </style>
</head>
<body class="bg-gray-100 antialiased">

    <div id="app">
        <!-- AUTHENTICATION VIEWS -->
        <div id="auth-container">
            <!-- LOGIN VIEW -->
            <div id="login-view" class="flex items-center justify-center min-h-screen auth-bg">
                <div class="w-full max-w-md p-8 space-y-6 bg-white/70 backdrop-blur-xl rounded-2xl shadow-lg fade-in-up">
                    <div class="text-center">
                        <i class="fa-solid fa-graduation-cap text-4xl text-indigo-600"></i>
                        <h2 class="mt-4 text-3xl font-bold tracking-tight text-gray-900">Sign In</h2>
                        <p class="mt-2 text-sm text-gray-600">Welcome back to the Follow-Up System</p>
                    </div>
                    <form id="login-form" class="mt-8 space-y-6" onsubmit="event.preventDefault(); handleLogin();">
                        <div class="space-y-4">
                             <input id="login-email" type="email" autocomplete="email" required class="w-full px-4 py-3 bg-white/80 text-gray-900 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition" placeholder="Email address">
                             <input id="login-password" type="password" autocomplete="current-password" required class="w-full px-4 py-3 bg-white/80 text-gray-900 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition" placeholder="Password">
                        </div>
                        <p id="login-error" class="text-sm text-center text-red-600 font-medium"></p>
                        <button type="submit" class="w-full px-4 py-3 font-semibold text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition transform hover:scale-105">Sign in</button>
                    </form>
                    <p class="text-sm text-center text-gray-600">Don't have an account? <span onclick="showSignupView()" class="font-medium text-indigo-600 hover:text-indigo-500 cursor-pointer">Sign Up</span></p>
                </div>
            </div>

            <!-- SIGNUP VIEW -->
            <div id="signup-view" class="hidden items-center justify-center min-h-screen auth-bg">
                 <div class="w-full max-w-md p-8 space-y-6 bg-white/70 backdrop-blur-xl rounded-2xl shadow-lg fade-in-up">
                    <div class="text-center">
                        <i class="fa-solid fa-user-plus text-4xl text-indigo-600"></i>
                        <h2 class="mt-4 text-3xl font-bold tracking-tight text-gray-900">Create Account</h2>
                        <p class="mt-2 text-sm text-gray-600">Get started by creating a new account</p>
                    </div>
                    <form id="signup-form" class="mt-8 space-y-4" onsubmit="event.preventDefault(); handleSignUp();">
                        <input id="signup-name" type="text" required class="w-full px-4 py-3 bg-white/80 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition" placeholder="Full Name">
                        <input id="signup-email" type="email" autocomplete="email" required class="w-full px-4 py-3 bg-white/80 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition" placeholder="Email address">
                        <input id="signup-password" type="password" required class="w-full px-4 py-3 bg-white/80 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition" placeholder="Password">
                        <select id="signup-role" required class="w-full px-4 py-3 bg-white/80 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition">
                            <option value="" disabled selected>Select your role</option>
                            <option value="admin">Admin</option>
                            <option value="staff">Staff</option>
                        </select>
                        <div class="flex items-center space-x-2">
                            <span id="captcha-question" class="text-gray-700 font-medium"></span>
                            <input id="captcha-answer" type="number" required class="w-full px-4 py-3 bg-white/80 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition" placeholder="Your answer">
                        </div>
                        <p id="signup-error" class="text-sm text-center text-red-600 font-medium"></p>
                        <button type="submit" class="w-full px-4 py-3 font-semibold text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition transform hover:scale-105">Sign Up</button>
                    </form>
                    <p class="text-sm text-center text-gray-600">Already have an account? <span onclick="showLoginView()" class="font-medium text-indigo-600 hover:text-indigo-500 cursor-pointer">Sign In</span></p>
                </div>
            </div>
        </div>

        <!-- MAIN DASHBOARD VIEW (Initially hidden) -->
        <div id="dashboard-view" class="hidden">
            <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>
            <!-- Sidebar -->
            <aside id="sidebar" class="bg-gray-800 text-gray-200 w-64 fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 z-40 sidebar flex flex-col">
                 <div class="flex items-center justify-between px-4 py-7 flex-shrink-0">
                    <a href="#" class="text-white flex items-center space-x-2">
                        <i class="fa-solid fa-graduation-cap fa-2x"></i>
                        <span class="sidebar-text text-2xl font-extrabold">EAMCET</span>
                    </a>
                    <button id="desktop-collapse-btn" class="hidden md:block text-gray-400 hover:text-white">
                        <i class="fa-solid fa-chevron-left transition-transform duration-300"></i>
                    </button>
                </div>

                <nav id="sidebar-nav" class="px-2 space-y-2 flex-grow">
                    <!-- Nav links will be injected here -->
                </nav>

                <div class="px-4 py-4 flex-shrink-0">
                    <div id="user-profile" class="text-center px-2">
                        <!-- User info injected here -->
                    </div>
                    <button onclick="handleLogout()" class="w-full mt-4 flex items-center justify-center py-2 px-4 text-sm font-medium rounded-lg text-white bg-red-500 hover:bg-red-600 transition">
                        <i class="fa-solid fa-right-from-bracket mr-2"></i> <span class="sidebar-text">Logout</span>
                    </button>
                </div>
            </aside>

            <!-- Main Content -->
            <div id="main-content" class="flex-1 flex flex-col overflow-hidden">
                <header class="bg-white shadow-sm flex items-center justify-between p-4 md:hidden">
                    <h1 class="text-xl font-bold text-gray-800">EAMCET Portal</h1>
                    <button id="hamburger-btn" class="text-gray-500 focus:outline-none z-50">
                        <i class="fa-solid fa-bars fa-lg"></i>
                    </button>
                </header>

                <main id="main-container" class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-4 md:p-8">
                    <!-- Dynamic content will be injected here -->
                    <div id="admin-content" class="hidden space-y-8"></div>
                    <div id="staff-content" class="hidden"></div>
                </main>
            </div>
        </div>
        
        <!-- MODAL -->
        <div id="summary-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 modal-backdrop">
            <div class="relative w-full max-w-2xl p-6 bg-white rounded-lg shadow-xl modal-content">
                <button onclick="closeModal()" class="absolute text-2xl text-gray-400 top-4 right-4 hover:text-gray-800 transition">&times;</button>
                <h3 id="modal-title" class="text-xl font-semibold text-gray-900">AI-Generated Content</h3>
                <div id="summary-content" class="mt-4 text-gray-600 prose max-w-none"></div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA STORE ---
        let students = [];
        let users = [];
        let captchaAnswer = 0;
        const defaultStudents = [
            { id: 1, name: 'Aarav Sharma', rank: 1250, phone: '9876543210', category: 'OC', upload_date: '2025-07-30', status: 'Interested', remarks: 'Wants CSE branch.', staff_id: 'Staff 1' },
            { id: 2, name: 'Diya Patel', rank: 2300, phone: '9876543211', category: 'BC-A', upload_date: '2025-07-30', status: 'Not Interested', remarks: 'Taking admission elsewhere.', staff_id: 'Staff 1' },
            { id: 3, name: 'Rohan Reddy', rank: 850, phone: '9876543212', category: 'OC', upload_date: '2025-07-31', status: 'Call Later', remarks: 'Asked to call back tomorrow.', staff_id: 'Staff 2' },
            { id: 4, name: 'Priya Kumar', rank: 3100, phone: '9876543213', category: 'SC', upload_date: '2025-07-31', status: 'Pending', remarks: '', staff_id: 'Staff 1' },
            { id: 5, name: 'Vikram Singh', rank: 4500, phone: '9876543214', category: 'OC', upload_date: '2025-08-01', status: 'Not Reachable', remarks: 'Phone switched off.', staff_id: 'Staff 2' },
        ];
        const statusColors = {
            'Interested': 'bg-green-100 text-green-800', 'Not Interested': 'bg-red-100 text-red-800',
            'Call Later': 'bg-yellow-100 text-yellow-800', 'Not Reachable': 'bg-blue-100 text-blue-800',
            'Joined Elsewhere': 'bg-purple-100 text-purple-800', 'Pending': 'bg-gray-100 text-gray-800'
        };
        const statusOptions = ['Interested', 'Not Interested', 'Call Later', 'Not Reachable', 'Joined Elsewhere'];
        const apiKey = "AIzaSyDEW_W4dINlWmqORvWl1RL3_9wTGzhnF3s";

        // DOM Elements
        const authContainer = document.getElementById('auth-container');
        const loginView = document.getElementById('login-view');
        const signupView = document.getElementById('signup-view');
        const dashboardView = document.getElementById('dashboard-view');
        const adminContent = document.getElementById('admin-content');
        const staffContent = document.getElementById('staff-content');
        const summaryModal = document.getElementById('summary-modal');
        const modalTitle = document.getElementById('modal-title');
        const summaryContent = document.getElementById('summary-content');
        const loginError = document.getElementById('login-error');
        const signupError = document.getElementById('signup-error');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const mainContent = document.getElementById('main-content');
        const hamburgerBtn = document.getElementById('hamburger-btn');
        const desktopCollapseBtn = document.getElementById('desktop-collapse-btn');
        const captchaQuestionEl = document.getElementById('captcha-question');

        // --- DATA PERSISTENCE ---
        function saveUsers() { localStorage.setItem('eamcetUsers', JSON.stringify(users)); }
        function saveStudents() { localStorage.setItem('eamcetStudents', JSON.stringify(students)); }
        function loadData() {
            users = JSON.parse(localStorage.getItem('eamcetUsers')) || [];
            const storedStudents = JSON.parse(localStorage.getItem('eamcetStudents'));
            students = (storedStudents && storedStudents.length > 0) ? storedStudents : defaultStudents;
        }

        // --- AUTH & VIEW MANAGEMENT ---
        function generateCaptcha() {
            const num1 = Math.floor(Math.random() * 10) + 1;
            const num2 = Math.floor(Math.random() * 10) + 1;
            captchaAnswer = num1 + num2;
            captchaQuestionEl.textContent = `What is ${num1} + ${num2}?`;
        }

        function showLoginView() {
            signupView.style.display = 'none';
            loginView.style.display = 'flex';
            document.getElementById('login-form').reset();
            loginError.className = 'text-sm text-center text-red-600 font-medium';
            loginError.textContent = '';
        }

        function showSignupView() {
            loginView.style.display = 'none';
            signupView.style.display = 'flex';
            document.getElementById('signup-form').reset();
            signupError.textContent = '';
            generateCaptcha();
        }

        function handleSignUp() {
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const role = document.getElementById('signup-role').value;
            const userAnswer = parseInt(document.getElementById('captcha-answer').value, 10);

            if (!name || !email || !password || !role) { signupError.textContent = 'All fields are required.'; return; }
            if (userAnswer !== captchaAnswer) { signupError.textContent = 'Incorrect CAPTCHA answer. Please try again.'; generateCaptcha(); return; }
            if (users.find(user => user.email === email)) { signupError.textContent = 'An account with this email already exists.'; return; }
            
            users.push({ name, email, password, role });
            saveUsers();
            loginError.textContent = 'Account created successfully! Please sign in.';
            loginError.className = 'text-sm text-center text-green-600 font-medium';
            showLoginView();
        }

        function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const user = users.find(u => u.email === email && u.password === password);
            if (user) {
                localStorage.setItem('loggedInUser', JSON.stringify(user));
                renderDashboard();
            } else { loginError.textContent = 'Invalid email or password.'; }
        }

        function handleLogout() {
            localStorage.removeItem('loggedInUser');
            authContainer.style.display = 'block';
            dashboardView.style.display = 'none';
        }

        // --- API & DATA FUNCTIONS ---
        async function callGeminiAPI(prompt, buttonElement = null) {
            let originalHTML;
            if (buttonElement) {
                buttonElement.disabled = true;
                originalHTML = buttonElement.innerHTML;
                buttonElement.innerHTML = `<i class="fa-solid fa-spinner fa-spin mr-2"></i> Thinking...`;
            }
            if (!apiKey) { return `Failed to generate content. Error: API Key is missing.`; }
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API returned status ${response.status}. ${errorData.error?.message || 'Unknown error.'}`);
                }
                const result = await response.json();
                return result.candidates?.[0]?.content?.parts?.[0]?.text || "No content generated.";
            } catch (error) {
                console.error('Error calling Gemini API:', error);
                return `Failed to generate content. Error: ${error.message}`;
            } finally {
                if (buttonElement) { buttonElement.disabled = false; buttonElement.innerHTML = originalHTML; }
            }
        }
        
        function updateStudentStatus(studentId, newStatus) {
            const student = students.find(s => s.id === studentId);
            if (student) {
                student.status = newStatus;
                saveStudents();
                // Instead of full re-render, just update the specific row's status display
                const statusSpan = document.querySelector(`tr[data-student-id='${studentId}'] .status-cell`);
                 if (statusSpan) {
                    statusSpan.className = `px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColors[newStatus] || ''} status-cell`;
                    statusSpan.textContent = newStatus;
                }
            }
        }
        
        function updateStudentRemarks(studentId, newRemarks) {
            const student = students.find(s => s.id === studentId);
            if (student) {
                student.remarks = newRemarks;
                saveStudents();
            }
        }
        
        async function suggestRemark(studentId, buttonElement) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            const prompt = `You are an admissions counselor assistant. For a student named ${student.name} with EAMCET rank ${student.rank}, generate a concise and professional call log remark. The current call status is "${student.status}". The remark should be a single sentence.`;
            const suggestedRemark = await callGeminiAPI(prompt, buttonElement);
            if (suggestedRemark.startsWith('Failed to generate content')) { showInfoModal('API Error', `<p>${suggestedRemark}</p>`); return; }
            const remarksInput = document.querySelector(`input[data-studentid="${studentId}"]`);
            if (remarksInput) { remarksInput.value = suggestedRemark.replace(/["']/g, ""); updateStudentRemarks(studentId, remarksInput.value); }
        }

        async function generateAdminSummary() {
            const btn = document.getElementById('generate-summary-btn');
            const stats = students.reduce((acc, student) => { acc[student.status] = (acc[student.status] || 0) + 1; return acc; }, {});
            const staffPerformance = students.reduce((acc, student) => { if (student.status !== 'Pending') { acc[student.staff_id] = (acc[student.staff_id] || 0) + 1; } return acc; }, {});
            const prompt = `You are an expert admissions analyst. Based on this week's EAMCET follow-up data (JSON format: ${JSON.stringify({ stats, staffPerformance })}), write a 2-paragraph summary in simple HTML. 1. Give a general overview of the calling effort. 2. Highlight key trends, mention the most active staff, and suggest one actionable area for improvement.`;
            showInfoModal('AI-Generated Weekly Summary', '<div class="flex justify-center items-center p-8"><i class="fa-solid fa-spinner fa-spin text-4xl text-indigo-500"></i></div>');
            const summary = await callGeminiAPI(prompt, btn);
            summaryContent.innerHTML = summary;
        }

        async function analyzeSentiments() {
            const btn = document.getElementById('analyze-sentiments-btn');
            const remarks = students.map(s => s.remarks).filter(Boolean).join('\n');
            if (!remarks) { showInfoModal('Sentiment Analysis', '<p>There are no remarks to analyze.</p>'); return; }
            const prompt = `You are a data analyst specializing in sentiment analysis for college admissions. Analyze the following call log remarks: "${remarks}". Provide an analysis in simple HTML format. 1. A main heading "Call Remark Sentiment Analysis". 2. A short summary paragraph of the overall sentiment. 3. A bulleted list categorizing the sentiment counts (e.g., Positive: X, Negative: Y, Neutral: Z). 4. One actionable insight based on the sentiment.`;
            showInfoModal('AI-Generated Sentiment Analysis', '<div class="flex justify-center items-center p-8"><i class="fa-solid fa-spinner fa-spin text-4xl text-indigo-500"></i></div>');
            const analysis = await callGeminiAPI(prompt, btn);
            summaryContent.innerHTML = analysis;
        }

        async function getTalkingPoints(studentId, buttonElement) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            const prompt = `You are a friendly college admissions counselor. Generate a short, personalized talking point for a phone call with an EAMCET-qualified student named ${student.name} with rank ${student.rank} and category ${student.category}. Generate two points in an HTML bulleted list: a personalized opening line, and a key college highlight.`;
            showInfoModal(`Talking Points for ${student.name}`, '<div class="flex justify-center items-center p-8"><i class="fa-solid fa-spinner fa-spin text-4xl text-indigo-500"></i></div>');
            const talkingPoints = await callGeminiAPI(prompt, buttonElement);
            summaryContent.innerHTML = talkingPoints;
        }

        async function predictInterest() {
            const btn = document.getElementById('predict-interest-btn');
            const pendingStudents = students.filter(s => s.status === 'Pending');
            if (pendingStudents.length === 0) {
                showInfoModal('Predict Interest', '<p>There are no pending students to analyze.</p>');
                return;
            }
            const studentData = pendingStudents.map(s => ({ name: s.name, rank: s.rank, category: s.category }));
            const prompt = `As an expert AI admissions analyst, predict the interest level (High, Medium, Low) for the following EAMCET students who are yet to be called. Base your prediction on their rank and category.
            Student Data: ${JSON.stringify(studentData)}
            
            Return the response as an HTML table with three columns: "Student Name", "Predicted Interest", and "Reasoning". Provide a brief justification for each prediction (e.g., "High rank in OC category suggests strong competition for top branches.").`;
            showInfoModal('AI Interest Prediction', '<div class="flex justify-center items-center p-8"><i class="fa-solid fa-spinner fa-spin text-4xl text-indigo-500"></i></div>');
            const prediction = await callGeminiAPI(prompt, btn);
            summaryContent.innerHTML = prediction;
        }

        function exportInterestedStudents() {
            const interestedStudents = students.filter(s => s.status === 'Interested');
            if (interestedStudents.length === 0) { showInfoModal('Export Information', '<p>There are no students marked as "Interested" to export.</p>'); return; }
            const exportData = interestedStudents.map(({ name, rank, phone, category, remarks, staff_id }) => ({ Name: name, Rank: rank, Phone: phone, Category: category, Remarks: remarks, "Called By": staff_id }));
            const worksheet = XLSX.utils.json_to_sheet(exportData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Interested Students");
            XLSX.writeFile(workbook, "Interested_EAMCET_Students.xlsx");
        }
        
        // --- UI & RENDERING ---
        function showInfoModal(title, content) {
            modalTitle.textContent = title;
            summaryContent.innerHTML = content;
            openModal();
        }

        function openModal() {
            summaryModal.style.display = 'flex';
            setTimeout(() => {
                summaryModal.classList.add('show', 'opacity-100');
            }, 10);
        }

        function closeModal() {
            summaryModal.classList.remove('show', 'opacity-100');
            setTimeout(() => {
                summaryModal.style.display = 'none';
                summaryContent.innerHTML = '';
            }, 300);
        }

        function renderDashboard(isUpdate = false) {
            const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
            if (!loggedInUser) { showLoginView(); return; }
            if (!isUpdate) { authContainer.style.display = 'none'; dashboardView.style.display = 'flex'; }
            
            document.getElementById('user-profile').innerHTML = `
                <div class="font-semibold text-lg sidebar-text">${loggedInUser.name}</div>
                <div class="text-sm text-gray-400 sidebar-text">${loggedInUser.role}</div>`;
            
            const nav = document.getElementById('sidebar-nav');
            if (loggedInUser.role === 'admin') {
                nav.innerHTML = `<a href="#" class="sidebar-link flex items-center py-2.5 px-4 rounded-lg bg-gray-700 text-white"><i class="fa-solid fa-table-columns w-8 text-center"></i><span class="sidebar-text ml-3">Dashboard</span></a>`;
                adminContent.style.display = 'block'; staffContent.style.display = 'none';
                if (!isUpdate) renderAdminDashboard(loggedInUser);
            } else {
                 nav.innerHTML = `<a href="#" class="sidebar-link flex items-center py-2.5 px-4 rounded-lg bg-gray-700 text-white"><i class="fa-solid fa-users w-8 text-center"></i><span class="sidebar-text ml-3">My Students</span></a>`;
                adminContent.style.display = 'none'; staffContent.style.display = 'block';
                if (!isUpdate) renderStaffDashboard(loggedInUser);
            }
        }
        
        function renderAdminDashboard(user) {
            adminContent.innerHTML = `
                <div class="fade-in-up" style="animation-delay: 0.1s;">
                    <div class="p-6 bg-white rounded-xl shadow-md card">
                         <h2 class="text-2xl font-bold text-gray-800">Welcome back, ${user.name}!</h2>
                         <p class="text-gray-500">Here's a snapshot of your team's progress.</p>
                         <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4 text-center">
                            <div class="p-4 bg-blue-50 rounded-lg"><div class="text-2xl font-bold text-blue-600">${students.length}</div><div class="text-sm text-gray-500">Total Students</div></div>
                            <div class="p-4 bg-green-50 rounded-lg"><div class="text-2xl font-bold text-green-600">${students.filter(s=>s.status === 'Interested').length}</div><div class="text-sm text-gray-500">Interested</div></div>
                            <div class="p-4 bg-yellow-50 rounded-lg"><div class="text-2xl font-bold text-yellow-600">${students.filter(s=>s.status === 'Pending').length}</div><div class="text-sm text-gray-500">Pending Calls</div></div>
                            <div class="p-4 bg-red-50 rounded-lg"><div class="text-2xl font-bold text-red-600">${students.filter(s=>s.status === 'Not Interested').length}</div><div class="text-sm text-gray-500">Not Interested</div></div>
                         </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mt-8">
                    <div class="lg:col-span-1 p-6 bg-white rounded-xl shadow-md card fade-in-up" style="animation-delay: 0.2s;">
                        <h3 class="font-bold text-gray-800 text-lg mb-4 flex items-center"><i class="fa-solid fa-upload mr-2 text-indigo-500"></i>Upload Student List</h3>
                        <label for="dropzone-file" class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition">
                            <i class="fa-solid fa-cloud-arrow-up text-3xl text-gray-400"></i>
                            <p class="text-sm text-gray-500 mt-2"><span class="font-semibold">Click to upload</span></p>
                            <input id="dropzone-file" type="file" class="hidden" accept=".csv, .xlsx, .xls" />
                        </label>
                        <p id="upload-status" class="mt-2 text-sm font-medium text-center opacity-0"></p>
                    </div>
                    <div class="lg:col-span-2 p-6 bg-white rounded-xl shadow-md card fade-in-up" style="animation-delay: 0.3s;">
                        <h3 class="font-bold text-gray-800 text-lg mb-4 flex items-center"><i class="fa-solid fa-wand-magic-sparkles mr-2 text-indigo-500"></i>AI-Powered Actions</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                            <button id="generate-summary-btn" onclick="generateAdminSummary()" class="flex items-center justify-center p-3 font-semibold text-white bg-purple-600 rounded-lg hover:bg-purple-700 transition transform hover:scale-105"><i class="fa-solid fa-lightbulb mr-2"></i>Summary</button>
                            <button id="analyze-sentiments-btn" onclick="analyzeSentiments()" class="flex items-center justify-center p-3 font-semibold text-white bg-sky-600 rounded-lg hover:bg-sky-700 transition transform hover:scale-105"><i class="fa-solid fa-magnifying-glass-chart mr-2"></i>Analyze</button>
                            <button id="predict-interest-btn" onclick="predictInterest()" class="flex items-center justify-center p-3 font-semibold text-white bg-orange-500 rounded-lg hover:bg-orange-600 transition transform hover:scale-105"><i class="fa-solid fa-rocket mr-2"></i>Predict</button>
                            <button id="export-interested-btn" onclick="exportInterestedStudents()" class="flex items-center justify-center p-3 font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700 transition transform hover:scale-105"><i class="fa-solid fa-file-excel mr-2"></i>Export</button>
                        </div>
                    </div>
                </div>
                <div class="mt-8 p-6 bg-white rounded-xl shadow-md fade-in-up" style="animation-delay: 0.4s;">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                        <h3 class="font-bold text-gray-800 text-lg flex items-center"><i class="fa-solid fa-table-list mr-2 text-indigo-500"></i>All Student Records</h3>
                        <div class="flex flex-wrap items-center gap-2">
                             <input id="admin-search" onkeyup="filterAdminTable()" type="text" placeholder="Search..." class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 w-full md:w-auto">
                            <select id="admin-filter-status" onchange="filterAdminTable()" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 w-full md:w-auto"></select>
                            <select id="admin-filter-staff" onchange="filterAdminTable()" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 w-full md:w-auto"></select>
                            <input id="admin-filter-date" onchange="filterAdminTable()" type="date" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 w-full md:w-auto">
                        </div>
                    </div>
                    <div id="admin-table-container" class="overflow-x-auto"></div>
                </div>`;
            
            document.getElementById('dropzone-file').addEventListener('change', handleFileUpload);
            
            const statusFilterEl = document.getElementById('admin-filter-status');
            statusFilterEl.innerHTML = '<option value="">All Statuses</option>' + Object.keys(statusColors).map(s => `<option value="${s}">${s}</option>`).join('');

            populateStaffFilter();
            filterAdminTable();
        }

        function populateStaffFilter() {
            const staffFilter = document.getElementById('admin-filter-staff');
            const uniqueStaff = [...new Set(students.map(s => s.staff_id).filter(Boolean))];
            const currentValue = staffFilter ? staffFilter.value : '';
            if (staffFilter) {
                staffFilter.innerHTML = '<option value="">All Staff</option>';
                uniqueStaff.forEach(staffId => staffFilter.add(new Option(staffId, staffId)));
                staffFilter.value = currentValue;
            }
        }

        function filterAdminTable() {
            const tableContainer = document.getElementById('admin-table-container');
            const searchTerm = document.getElementById('admin-search').value.toLowerCase();
            const statusFilter = document.getElementById('admin-filter-status').value;
            const staffFilter = document.getElementById('admin-filter-staff').value;
            const dateFilter = document.getElementById('admin-filter-date').value;
            
            const filteredStudents = students.filter(s => 
                (!searchTerm || s.name.toLowerCase().includes(searchTerm) || s.rank.toString().includes(searchTerm)) &&
                (!statusFilter || s.status === statusFilter) &&
                (!staffFilter || s.staff_id === staffFilter) &&
                (!dateFilter || s.upload_date === dateFilter)
            );

            if (filteredStudents.length === 0) {
                tableContainer.innerHTML = `<div class="text-center py-10 text-gray-500"><i class="fa-solid fa-folder-open text-4xl mb-4"></i><p class="font-semibold">No students found.</p><p>Try adjusting your filters or uploading a new list.</p></div>`;
                return;
            }

            tableContainer.innerHTML = `<table class="min-w-full">
                        <thead class="bg-gray-50"><tr>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Details</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Called By</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Remarks</th>
                        </tr></thead>
                        <tbody id="admin-student-table" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>`;

            const adminTableBody = document.getElementById('admin-student-table');
            adminTableBody.innerHTML = filteredStudents.map(student => `
                <tr class="hover:bg-gray-50 transition">
                    <td class="px-6 py-4 whitespace-nowrap"><div class="font-medium text-gray-900">${student.name || 'N/A'}</div><div class="text-sm text-gray-500">${student.phone || 'N/A'}</div></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Rank: ${student.rank || 'N/A'}<br>Cat: ${student.category || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColors[student.status] || ''}">${student.status}</span></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${student.staff_id || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 max-w-xs truncate" title="${student.remarks}">${student.remarks || '--'}</td>
                </tr>`).join('');
        }
        
        function renderStaffDashboard(currentUser) {
            staffContent.innerHTML = `
                <div class="p-6 bg-white rounded-xl shadow-md fade-in-up">
                    <h3 class="font-bold text-gray-800 text-lg mb-4 flex items-center"><i class="fa-solid fa-user-check mr-2 text-indigo-500"></i>My Assigned Students</h3>
                    <div id="staff-table-container" class="overflow-x-auto"></div>
                </div>`;
            const staffTableContainer = document.getElementById('staff-table-container');
            const staffStudents = students.filter(s => s.staff_id); // Simplified for demo
            
            if (staffStudents.length === 0) {
                staffTableContainer.innerHTML = `<div class="text-center py-10 text-gray-500"><i class="fa-solid fa-folder-open text-4xl mb-4"></i><p class="font-semibold">No students assigned.</p></div>`;
                return;
            }

            staffTableContainer.innerHTML = `<table class="min-w-full">
                        <thead class="bg-gray-50"><tr>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Student</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Actions & Remarks</th>
                        </tr></thead>
                        <tbody id="staff-student-table" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>`;

            const staffTableBody = document.getElementById('staff-student-table');
            staffTableBody.innerHTML = staffStudents.map(student => `
                <tr class="hover:bg-gray-50 transition" data-student-id="${student.id}">
                    <td class="px-6 py-4 whitespace-nowrap"><div class="font-medium text-gray-900">${student.name}</div><div class="text-sm text-gray-500">Rank: ${student.rank}</div></td>
                    <td class="px-6 py-4 whitespace-nowrap"><span class="status-cell px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColors[student.status] || ''}">${student.status}</span></td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center space-x-2">
                            <select onchange="updateStudentStatus(${student.id}, this.value)" class="w-36 px-2 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">${statusOptions.map(o => `<option value="${o}" ${student.status === o ? 'selected' : ''}>${o}</option>`).join('')}</select>
                            <input type="text" value="${student.remarks || ''}" data-studentid="${student.id}" onblur="updateStudentRemarks(${student.id}, this.value)" placeholder="Add remarks..." class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <button onclick="suggestRemark(${student.id}, this)" class="p-2 text-white bg-indigo-500 rounded-lg hover:bg-indigo-600 transition" title="Suggest Remark"><i class="fa-solid fa-lightbulb"></i></button>
                            <button onclick="getTalkingPoints(${student.id}, this)" class="p-2 text-white bg-teal-500 rounded-lg hover:bg-teal-600 transition" title="Get Talking Points"><i class="fa-solid fa-comments"></i></button>
                        </div>
                    </td>
                </tr>`).join('');
        }
        
        function showUploadStatus(message, type = 'success') {
            const statusEl = document.getElementById('upload-status');
            statusEl.textContent = message;
            statusEl.className = `mt-2 text-sm font-medium text-center opacity-100 ${type === 'error' ? 'text-red-600' : 'text-green-600'}`;
            setTimeout(() => { statusEl.classList.add('opacity-0'); }, 5000);
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const workbook = XLSX.read(e.target.result, { type: 'array' });
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    if (jsonData.length === 0) { showUploadStatus('File is empty.', 'error'); return; }
                    const today = new Date().toISOString().slice(0, 10);
                    const newStudents = jsonData.map((row, index) => ({
                        id: Date.now() + index, name: row.Name || row.name, rank: row.Rank || row.rank,
                        phone: row.Phone || row.phone, category: row.Category || row.category, upload_date: today,
                        status: 'Pending', remarks: '', staff_id: `Staff ${(index % 3) + 1}`
                    }));
                    if (!newStudents[0]?.name || !newStudents[0]?.rank) { showUploadStatus('Upload failed. Check column headers.', 'error'); return; }
                    students = newStudents;
                    saveStudents();
                    showUploadStatus(`${newStudents.length} students loaded successfully!`, 'success');
                    renderDashboard(true);
                } catch (error) { console.error("File processing error:", error); showUploadStatus('Error processing file.', 'error'); }
            };
            reader.readAsArrayBuffer(file);
        }

        // --- INITIAL LOAD & EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
            if (loggedInUser && users.find(u => u.email === loggedInUser.email)) {
                renderDashboard();
            } else {
                authContainer.style.display = 'block';
                dashboardView.style.display = 'none';
                showLoginView();
            }

            const toggleSidebar = () => {
                sidebar.classList.toggle('collapsed');
            }

            desktopCollapseBtn.addEventListener('click', toggleSidebar);

            hamburgerBtn.addEventListener('click', () => {
                sidebar.classList.remove('-translate-x-full');
                sidebarOverlay.classList.remove('hidden');
            });
            
            sidebarOverlay.addEventListener('click', () => {
                sidebar.classList.add('-translate-x-full');
                sidebarOverlay.classList.add('hidden');
            });

            window.addEventListener('click', (event) => { if (event.target == summaryModal) closeModal(); });

        });

    </script>
</body>
</html>

